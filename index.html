<!DOCTYPE html>
<html lang="ja">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Global Strategy: Absolute Final Fix</title>
  
 <!-- Fonts -->
 <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+JP:wght@300;400;700&display=swap" rel="stylesheet">
  
 <!-- Libraries -->
 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
 <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
 <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>

<style>
 :root { --bg-color: #050505; --panel-bg: rgba(15, 20, 25, 0.95); --neon-blue: #00f3ff; --neon-red: #ff0055; --neon-green: #00ff99; --neon-gold: #ffcc00; --neon-purple: #bd00ff; }
 body { font-family: 'Noto Sans JP', sans-serif; background-color: var(--bg-color); color: #e0e6ed; margin: 0; padding: 0; height: 100vh; overflow: hidden; }
 .app-container { display: flex; height: 100%; }
 .map-section { flex: 1; position: relative; }
 #gameMap { width: 100%; height: 100%; background: #0b0b0b; }
 .sidebar { width: 360px; min-width: 300px; background: var(--panel-bg); border-left: 1px solid #333; display: flex; flex-direction: column; padding: 15px; box-shadow: -5px 0 20px rgba(0,0,0,0.8); z-index: 100; overflow-y: auto; }
 h1 { color: var(--neon-blue); text-align: center; font-family: 'Orbitron'; font-size: 1.4em; border-bottom: 2px solid var(--neon-blue); padding-bottom: 10px; margin-top: 0; }
 h3 { color: var(--neon-gold); font-size: 0.9em; margin-top: 15px; border-left: 3px solid var(--neon-gold); padding-left: 8px; font-family: 'Orbitron'; }
 .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
 .stat-card { background: #1a1a1a; padding: 8px; border-radius: 4px; text-align: center; border: 1px solid #333; position: relative; }
 .stat-val { font-family: 'Orbitron'; font-size: 1.1em; color: white; display: block; }
 .stat-label { font-size: 0.7em; color: #888; }
 .res-icon { color: var(--neon-purple); font-weight: bold; }
 button { width: 100%; padding: 10px; margin-bottom: 5px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-family: 'Noto Sans JP'; transition: 0.2s; }
 button:hover { filter: brightness(1.2); }
 button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
 .btn-main { background: var(--neon-blue); color: black; }
 .btn-war { background: var(--neon-red); color: white; }
 .btn-buy { background: var(--neon-green); color: black; }
 .btn-eco { background: var(--neon-purple); color: white; }
 .btn-dm { background: #fff; color: #000; border: 1px solid var(--neon-blue); }
 .btn-draft { background: linear-gradient(45deg, #550000, #ff0000); color: white; border: 1px solid red; }
 .btn-trade { background: var(--neon-gold); color: black; }
 .btn-sub { background: #333; color: #ccc; }
 input { background: #222; border: 1px solid #555; color: white; padding: 10px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
 .tabs { display: flex; gap: 2px; margin-bottom: 10px; }
 .tab { flex: 1; padding: 8px; background: #222; color: #888; text-align: center; cursor: pointer; font-size: 0.7em; }
 .tab.active { background: #333; color: var(--neon-blue); border-bottom: 2px solid var(--neon-blue); }
 .rank-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid #222; font-size: 0.85em;}
 .rank-num { font-family: 'Orbitron'; color: var(--neon-gold); width: 20px; font-weight: bold;}
 canvas { border: 1px solid #555; background: #000; cursor: crosshair; image-rendering: pixelated; margin: 0 auto; display: block;}
 .palette { display: flex; justify-content: center; gap: 5px; margin-top: 5px; flex-wrap: wrap;}
 .color-dot { width: 20px; height: 20px; border-radius: 50%; border: 1px solid #fff; cursor: pointer; }
 .pop-flag { width: 80px; height: 50px; border: 1px solid #ccc; display: block; margin: 0 auto 5px auto; image-rendering: pixelated; }
 .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; }
 .modal { background: #111; border: 1px solid var(--neon-blue); padding: 30px; width: 400px; max-width: 90%; text-align: center; border-radius: 8px; box-shadow: 0 0 20px var(--neon-blue); }
 .hidden { display: none !important; }
 #adminPanel { position: fixed; top: 5%; left: 5%; width: 90%; height: 90%; background: #000; border: 2px solid var(--neon-red); z-index: 10000; padding: 20px; overflow-y: auto; color: var(--neon-red); box-sizing: border-box; }
 table { width: 100%; border-collapse: collapse; margin-top: 10px; color: #ccc; font-size: 0.85em; }
 th, td { border: 1px solid #333; padding: 8px; text-align: center; }
 .admin-edit-btn { background: #333; color: #00f3ff; border: 1px solid #555; padding: 2px 5px; font-size: 0.8em; cursor: pointer; }
 #debugLog { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.8); color: lime; font-size: 10px; z-index: 20000; padding: 2px; }
</style>
</head> 
<body>

<div id="overlayStart" class="overlay"> 
 <div id="menuMain" class="modal">  
 <h1>Global Strategy</h1>  
 <p style="color:#aaa;">é ˜åœŸäº‰å¥ªãƒ»å›½å®¶é‹å–¶ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</p>  
 <div id="loadingMsg" style="color:var(--neon-green); margin-bottom:10px; display:none;">è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ä¸­...</div>  
 <button class="btn-main" onclick="showScreen('Register')">ğŸŒ æ–°è¦å»ºå›½</button>  
 <button class="btn-buy" onclick="showScreen('Login')">ğŸ”‘ ãƒ­ã‚°ã‚¤ãƒ³</button>  
 <button class="btn-sub" onclick="startSpectator()">ğŸ‘ï¸ è¦³æˆ¦ãƒ¢ãƒ¼ãƒ‰</button> 
 </div>
 <div id="menuRegister" class="modal hidden">  
 <h2>æ–°è¦å»ºå›½</h2> 
 <input type="text" id="regName" placeholder="å›½å"> 
 <input type="password" id="regPass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"> 
 <input type="text" id="regCurrency" placeholder="é€šè²¨å˜ä½ (ä¾‹: å††, Dollar)"> 
 <button id="btnRegSubmit" class="btn-main" onclick="register()">ä½œæˆ</button> 
 <button class="btn-sub" onclick="showScreen('Main')">æˆ»ã‚‹</button> 
 </div>
 <div id="menuLogin" class="modal hidden">  
 <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2> 
 <input type="text" id="loginName" placeholder="å›½å"> 
 <input type="password" id="loginPass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"> 
 <button class="btn-buy" id="loginSubmitBtn" onclick="login()">å…¥å›½</button> 
 <button class="btn-sub" onclick="showScreen('Main')">æˆ»ã‚‹</button> 
 </div>
</div>

<div id="overlayAdminAuth" class="overlay hidden"> 
 <div class="modal" style="border-color:red;"> 
 <h2>ç®¡ç†è€…èªè¨¼</h2> 
 <input type="password" id="adminKey" placeholder="Password"> 
 <button class="btn-war" onclick="attemptAdminLogin()">UNLOCK</button> 
 <button class="btn-sub" onclick="document.getElementById('overlayAdminAuth').classList.add('hidden')">æˆ»ã‚‹</button> 
 </div> 
</div>

<div id="adminPanel" class="hidden"> 
 <h2>âš ï¸ ã‚µãƒ¼ãƒãƒ¼ç®¡ç†ã‚³ãƒ³ã‚½ãƒ¼ãƒ«</h2> 
 <div style="margin-bottom:10px;"> 
 <button class="btn-sub" style="width:100px;" onclick="closeAdmin()">é–‰ã˜ã‚‹</button> 
 <button class="btn-main" style="width:150px;" onclick="refreshAdminList()">ãƒªã‚¹ãƒˆæ›´æ–°</button> 
 </div> 
 <table><thead><tr><th>å›½å</th><th>è³‡é‡‘</th><th>å¹¸ç¦</th><th>äººå£</th><th>é¢ç©</th><th>GDP</th><th>æ“ä½œ</th></tr></thead><tbody id="adminTableBody"></tbody></table> 
</div>

<div id="gameUI" class="app-container hidden"> 
 <div class="map-section"> 
 <div id="gameMap"></div> 
 <div id="mapMsg" style="position:absolute; top:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.9); padding:15px; border:2px solid var(--neon-gold); color:var(--neon-gold); display:none; z-index:1000; pointer-events:none;"><b>ã€é ˜åœŸæç”»ãƒ¢ãƒ¼ãƒ‰ã€‘</b></div> 
 </div>
 <div class="sidebar">  
 <h1><span id="uiName">NATION</span></h1>  
 <div class="stats-grid">
  <div class="stat-card"><span class="stat-label">è³‡é‡‘</span><span class="stat-val" id="valMoney">0</span><span style="font-size:0.7em" id="uiCurrency">$</span></div>
  <div class="stat-card"><span class="stat-label">äººå£</span><span class="stat-val" id="valPop">0</span><span style="font-size:0.7em">äºº</span></div>
  <div class="stat-card"><span class="stat-label">é¢ç©</span><span class="stat-val" id="valArea">0</span><span style="font-size:0.7em">kmÂ²</span></div>
  <div class="stat-card"><span class="stat-label">å¹¸ç¦åº¦</span><span class="stat-val" id="valHappy" style="color:var(--neon-green);">100</span><span style="font-size:0.7em">%</span></div>
  <div class="stat-card"><span class="stat-label">çŸ³æ²¹ <span class="res-icon">ğŸ›¢ï¸</span></span><span class="stat-val" id="valOil">0</span></div>
  <div class="stat-card"><span class="stat-label">é‰„é‰±çŸ³ <span class="res-icon">â›ï¸</span></span><span class="stat-val" id="valIron">0</span></div>
 </div>
 <div class="tabs"> <div class="tab active" onclick="setTab('main')">å†…æ”¿</div> <div class="tab" onclick="setTab('war')">è»äº‹ãƒ»å¤–äº¤</div> <div class="tab" onclick="setTab('rank')">é †ä½</div> <div class="tab" onclick="setTab('flag')">å›½æ——</div> </div>
  
 <div id="playerControls">
  <div id="tab-main"> 
    <h3>çµŒæ¸ˆãƒ»è²¡å‹™</h3> 
    <div style="font-size:0.8em; color:#ccc; margin-bottom:5px;">GDP: <b id="valGDP">0</b> <span id="uiCurrency2">$</span> / ç¶­æŒè²»: <span id="valUpkeep" style="color:var(--neon-red)">0</span></div>
    <button class="btn-main" onclick="invest()">ğŸ­ ç”£æ¥­æŠ•è³‡ (-2000)</button> 
    <button class="btn-eco" onclick="sellResources()">ğŸ’° è³‡æºå£²å´</button>
    <button class="btn-war" onclick="printMoney()">ğŸ’¸ é€šè²¨ç™ºè¡Œ (+10k/å¹¸â†“)</button>
    <div style="margin-top:10px; font-size:0.8em; border-top:1px solid #333; padding-top:5px;">æ‰€å¾—ç¨ç‡: <span id="taxVal" style="color:var(--neon-blue)">10</span>% <input type="range" id="taxRate" min="0" max="80" value="10" onchange="document.getElementById('taxVal').innerText=this.value"></div> 
    <h3>é ˜åœŸ</h3> 
    <button class="btn-buy" onclick="startExpansion()">ğŸ—ºï¸ é ˜åœŸè³¼å…¥ãƒ»æç”»</button> 
    <button class="btn-sub" onclick="manualSave()">ğŸ’¾ ã‚µãƒ¼ãƒãƒ¼ä¿å­˜</button> 
    <button class="btn-sub" onclick="doLogout()">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button> 
  </div>
  <div id="tab-war" class="hidden"> 
    <h3>è»å‚™ (æˆ¦é—˜åŠ›: <span id="valMil">0</span>)</h3> 
    <button class="btn-war" onclick="recruit()">âš”ï¸ é€šå¸¸é›‡ç”¨ (-$1k / -500äºº)</button> 
    <button class="btn-draft" onclick="draftSoldiers()">ğŸ“¢ å¼·åˆ¶å¾´å…µ (ç„¡æ–™ / å¹¸ç¦â†“â†“)</button>
    <h3>å¤–äº¤ãƒ»å·¥ä½œ</h3> 
    <div id="requestBox" style="background:#1a1a1a; padding:10px; border-radius:4px; margin-bottom:10px; font-size:0.85em; border:1px solid #333;">ç”³è«‹ãªã—</div> 
    <h3>ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ</h3> 
    <div class="stat-card" style="text-align:left; margin-bottom:10px; border-color:var(--neon-red);">å¯¾è±¡: <b id="targetName">ãªã—</b><br>çŠ¶æ…‹: <span id="targetStatus">---</span><br><div id="warAutoMsg" style="color:var(--neon-red); font-size:0.8em; display:none;">âš ï¸ è‡ªå‹•æˆ¦äº‰é€²è¡Œä¸­...</div></div> 
    <div style="display:flex; gap:5px;">
      <button class="btn-trade" id="btnSendMoney" onclick="sendMoney()" disabled>ğŸ’¸ é€é‡‘</button>
      <button class="btn-trade" id="btnCedeLand" onclick="startTransferGeo()" disabled>ğŸ—ºï¸ é ˜åœŸè­²æ¸¡</button>
    </div>
    <button class="btn-dm" id="btnDM" onclick="sendDM()" disabled>ğŸ“© å¯†æ›¸é€ä¿¡ (å±¥æ­´ãªã—)</button>
    <button class="btn-buy" id="btnAlly" onclick="actionAlly()" disabled>ğŸ¤ åŒç›Ÿç”³è«‹</button> 
    <button class="btn-war" id="btnWar" onclick="actionWar()" disabled>ğŸ’£ å®£æˆ¦å¸ƒå‘Š</button> 
  </div>
  <div id="tab-flag" class="hidden"> <h3>å›½æ——ã‚¨ãƒ‡ã‚£ã‚¿</h3> <canvas id="flagCanvas" width="100" height="60"></canvas> <div class="palette" id="paletteBox"></div> <button class="btn-main" onclick="saveFlag()">ğŸ’¾ ä¿å­˜</button> <button class="btn-sub" onclick="clearFlag()">ğŸ—‘ ã‚¯ãƒªã‚¢</button> </div>
 </div>
  
 <div id="spectatorMsg" class="hidden" style="padding:20px; text-align:center; color:var(--neon-green);">
   <h3>ğŸ‘ï¸ è¦³æˆ¦ãƒ¢ãƒ¼ãƒ‰ä¸­</h3>
   <p>æ“ä½œã¯ã§ãã¾ã›ã‚“ã€‚<br>ä¸–ç•Œæƒ…å‹¢ã‚’è¦³å¯Ÿã—ã¦ã„ã¾ã™ã€‚</p>
   <button class="btn-sub" onclick="location.reload()">ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</button>
 </div>
  
 <div id="cancelOverlay" style="position:fixed; bottom:20px; left:50%; transform:translateX(-50%); z-index:2000; display:none;">
   <button class="btn-war" style="width:200px; box-shadow:0 0 10px red;" onclick="cancelActionMode()">âŒ ãƒ¢ãƒ¼ãƒ‰çµ‚äº†</button>
 </div>

 <div id="tab-rank" class="hidden"> <h3>ä¸–ç•Œå›½åŠ›ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3> <div id="rankingList"></div> </div>
 <div style="margin-top:auto; font-size:0.7em; color:#555; text-align:center;">Shift+Alt: Admin Panel</div>
 </div>
</div>

<div id="debugLog">System Initialized.</div>

<script>
 // --- Constants ---
 const PANTRY_ID = "5355906c-0f7f-4e97-9c05-65490bfe8f59";
 const BASKET_NAME = "strategy_complete_final";
 const API_URL = "https://getpantry.cloud/apiv1/pantry/" + PANTRY_ID + "/basket/" + BASKET_NAME;

 // --- Globals ---
 let myName = "", myData = {}, map, drawnItems, drawControl, selectedTarget = null;
 let expansionMode = false, transferMode = false, isSyncing = false, isSpectator = false;
 let lastWorldDataStr = "";

 function log(msg) {
   console.log(msg);
   document.getElementById('debugLog').innerText = msg;
 }

 // --- UI Functions ---
 function showScreen(id) {
   ['Main','Register','Login'].forEach(n => document.getElementById('menu'+n).classList.add('hidden'));
   const target = document.getElementById('menu'+id);
   if(target) target.classList.remove('hidden');
   log("UI: " + id);
 }

 function setTab(id) {
   document.querySelectorAll('[id^="tab-"]').forEach(e => e.classList.add('hidden'));
   document.getElementById('tab-'+id).classList.remove('hidden');
   document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
   if(event && event.target) event.target.classList.add('active');
   if(id === 'rank') updateRanking(); 
   if(id === 'flag') initFlagEditor();
 }

 // --- DB Access ---
 async function getDB() { 
   try { 
     const r = await fetch(API_URL + "?t=" + Date.now()); 
     if(r.ok) {
       const raw = await r.json();
       if(raw.compressed && raw.data) {
         const decompressed = LZString.decompressFromUTF16(raw.data);
         return decompressed ? JSON.parse(decompressed) : { nations: {} };
       }
       return raw.nations ? raw : { nations: {} };
     }
   } catch(e){ log("DB Fetch Error: " + e.message); } 
   return { nations: {} }; 
 }

 async function saveWorldDB(db) {
   if(isSpectator) return;
   isSyncing = true; log("Saving...");
   try {
     const compressedStr = LZString.compressToUTF16(JSON.stringify(db));
     const payload = JSON.stringify({compressed:true, data:compressedStr});
     await fetch(API_URL, { method:"POST", headers:{"Content-Type":"application/json"}, body: payload });
     log("Saved.");
   } catch(e) { log("Save Failed."); }
   isSyncing = false; 
 }
  
 async function saveMe(newData) {
  if(isSyncing || isSpectator) return;
  try {
   const db = await getDB();
   if(!db.nations) db.nations = {};
   db.nations[myName] = newData;
   await saveWorldDB(db);
   myData = newData; 
  } catch(e) { log(e.message); }
 }

 // --- Auth ---
 async function register() {
  const btn = document.getElementById('btnRegSubmit');
  if(btn) { btn.disabled = true; btn.innerText = "..."; }
  try {
    const n = document.getElementById('regName').value;
    const p = document.getElementById('regPass').value;
    const curr = document.getElementById('regCurrency').value || "$";
    if(!n || !p) throw new Error("å…¥åŠ›ä¸è¶³");
    const db = await getDB(); 
    if(db.nations && db.nations[n]) throw new Error("ä½¿ç”¨æ¸ˆã¿");
    if(!db.nations) db.nations = {};
    db.nations[n] = { 
      pass: p, money: 20000000, population: 50000, gdp: 5000, military: 500, 
      area: 0, geometries: [], allies: [], requests: [], warTarget: null, flag: null,
      happiness: 100, currency: curr, resources: { oil: 0, iron: 0 }, secretMsg: null
    };
    await saveWorldDB(db); 
    alert("æˆåŠŸ"); showScreen('Login');
  } catch(e) { alert(e.message); } 
  finally { if(btn) { btn.disabled = false; btn.innerText = "ä½œæˆ"; } }
 }

 async function login(an, ap) {
  const btn = document.getElementById('loginSubmitBtn');
  if(btn) { btn.disabled = true; btn.innerText = "..."; }
  try {
    const n = an || document.getElementById('loginName').value;
    const p = ap || document.getElementById('loginPass').value;
    if(!n || !p) throw new Error("å…¥åŠ›ä¸è¶³");
    const db = await getDB();
    const target = db.nations ? db.nations[n] : null;
    if(!target || target.pass !== p) throw new Error("èªè¨¼å¤±æ•—");
    localStorage.setItem('autoName', n); localStorage.setItem('autoPass', p);
    myName = n; myData = target;
    if(!myData.geometries) myData.geometries = []; 
    if(!myData.allies) myData.allies = []; 
    if(!myData.requests) myData.requests = [];
    if(!myData.resources) myData.resources = { oil: 0, iron: 0 };
    document.getElementById('overlayStart').classList.add('hidden'); 
    document.getElementById('gameUI').classList.remove('hidden');
    initMap(); startRealTimeSync(); 
  } catch(e) {
    alert(e.message);
    document.getElementById('loadingMsg').style.display = 'none';
  } finally {
    if(btn) { btn.disabled = false; btn.innerText = "å…¥å›½"; }
  }
 }

 function startRealTimeSync() {
  setInterval(syncWorld, 3000); 
  if(!isSpectator) setInterval(ecoTick, 10000);  
 }

 async function syncWorld() {
  if(isSyncing) return;
  const db = await getDB();
  if(!db.nations) return; 

  const currentDataStr = JSON.stringify(db.nations);
  if(currentDataStr !== lastWorldDataStr) {
   renderWorld(db.nations);
   lastWorldDataStr = currentDataStr;
   if(!isSpectator && db.nations[myName] && !expansionMode) {
    const sMe = db.nations[myName];
    myData.area = sMe.area;
    myData.geometries = sMe.geometries;
    myData.warTarget = sMe.warTarget;
    myData.requests = sMe.requests || [];
    myData.allies = sMe.allies || [];
    myData.population = sMe.population;
    myData.happiness = sMe.happiness;
    myData.resources = sMe.resources || {oil:0, iron:0};
    if(Math.abs(sMe.money - myData.money) > 5000) myData.money = sMe.money;
    if(sMe.secretMsg) {
      alert("ğŸ“© å¯†æ›¸ from " + sMe.secretMsg.from + ":\n" + sMe.secretMsg.msg);
      sMe.secretMsg = null;
      db.nations[myName] = sMe;
      await saveWorldDB(db);
    }
   }
   refreshUI();
   if(!document.getElementById('tab-rank').classList.contains('hidden')) updateRanking(db);
  }
 }

 function startSpectator() {
   isSpectator = true;
   document.getElementById('overlayStart').classList.add('hidden');
   document.getElementById('gameUI').classList.remove('hidden');
   document.getElementById('playerControls').classList.add('hidden');
   document.getElementById('spectatorMsg').classList.remove('hidden');
   document.getElementById('uiName').innerText = "SPECTATOR";
   initMap(); startRealTimeSync();
 }

 // --- Map ---
 function initMap() {
  if(map) return;
  map = L.map('gameMap').setView([35, 135], 4);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
  drawnItems = new L.FeatureGroup(); map.addLayer(drawnItems);
  map.on('popupopen', e => {
   const container = document.createElement('div');
   container.innerHTML = e.popup.getContent();
   const bTag = container.querySelector('b');
   if(bTag && bTag.innerText !== myName && !isSpectator) selectTarget(bTag.innerText);
  });
  map.on('click', async e => {
    if(transferMode && selectedTarget) {
      const clickedPoint = turf.point([e.latlng.lng, e.latlng.lat]);
      let foundIdx = -1;
      for(let i=0; i<myData.geometries.length; i++) {
        if(turf.booleanPointInPolygon(clickedPoint, myData.geometries[i])) { foundIdx = i; break; }
      }
      if(foundIdx !== -1 && confirm("è­²æ¸¡: " + selectedTarget + "ã¸?")) {
        const db = await getDB();
        const poly = db.nations[myName].geometries.splice(foundIdx, 1)[0];
        db.nations[selectedTarget].geometries.push(poly);
        // Recalc areas
        [myName, selectedTarget].forEach(k => {
          let a = 0; db.nations[k].geometries.forEach(g => a += Math.round(turf.area(g)/1000000));
          db.nations[k].area = a;
        });
        await saveWorldDB(db); alert("å®Œäº†"); cancelActionMode();
      }
    }
  });
 }

 function renderWorld(ns) {
  if(!drawnItems) return;
  drawnItems.clearLayers();
  Object.keys(ns).forEach(key => {
   const n = ns[key];
   const isMe = (key === myName);
   const isAlly = (myData.allies || []).includes(key);
   const isWar = (myData.warTarget === key);
   let color = isMe ? "#00f3ff" : (isWar ? "#ff8800" : (isAlly ? "#00ff99" : "#ff0055"));
   const fImg = n.flag ? `<img src="${n.flag}" class="pop-flag">` : "";
   (n.geometries || []).forEach(geo => {
    L.geoJSON(geo, { style: { color: color, weight: 2, fillOpacity: 0.3 } })
    .bindPopup(`<div style="text-align:center;">${fImg}<b>${key}</b><br>è»äº‹: ${n.military}<br>äººå£: ${Math.floor(n.population || 0).toLocaleString()}<br>å¹¸ç¦: ${n.happiness || 100}%</div>`).addTo(drawnItems);
   });
  });
 }

 function startExpansion() {
  if(isSpectator) return;
  expansionMode = true; 
  document.getElementById('mapMsg').innerText="ã€é ˜åœŸè³¼å…¥ãƒ¢ãƒ¼ãƒ‰ã€‘"; 
  document.getElementById('mapMsg').style.display = 'block';
  document.getElementById('cancelOverlay').style.display = 'block'; 
  if(drawControl) map.removeControl(drawControl);
  drawControl = new L.Control.Draw({ draw: { polygon: { allowIntersection: false }, rectangle:true, circle:false, marker:false, polyline:false }, edit: false });
  map.addControl(drawControl);
  map.once(L.Draw.Event.CREATED, async e => {
   if(!expansionMode) return;
   const newGeo = e.layer.toGeoJSON(); 
   const db = await getDB(); 
   let overlap = false;
   Object.keys(db.nations).forEach(k => { (db.nations[k].geometries || []).forEach(g => { if(turf.intersect(newGeo, g)) overlap = true; }); });
   if(overlap) { alert("é‡è¤‡ã—ã¦ã„ã¾ã™"); cancelActionMode(); return; }
   const a = Math.round(turf.area(newGeo)/1000000);
   const cost = myData.area === 0 ? 0 : a * 100;
   if(myData.money >= cost && confirm("è²»ç”¨ " + cost.toLocaleString() + " ã§è³¼å…¥?")) {
    myData.geometries.push(newGeo);
    myData.money -= cost; 
    let totalA = 0; myData.geometries.forEach(g => totalA += Math.round(turf.area(g)/1000000));
    myData.area = totalA;
    await saveMe(myData); alert("è³¼å…¥å®Œäº†");
   }
   cancelActionMode();
  });
 }
  
 function cancelActionMode() {
   expansionMode = false; transferMode = false;
   document.getElementById('mapMsg').style.display = 'none';
   document.getElementById('cancelOverlay').style.display = 'none';
   if(drawControl) map.removeControl(drawControl);
 }

 // --- Logic ---
 async function ecoTick() { 
  if(!myData.gdp || isSpectator) return;
  const upkeep = myData.military * 2; 
  if(myData.money >= upkeep) myData.money -= upkeep;
  else { myData.military = Math.floor(myData.money / 2); myData.money = 0; myData.happiness = Math.max(0, myData.happiness - 2); }
  const tax = parseInt(document.getElementById('taxRate').value);
  myData.money += myData.gdp * (tax/100); 
  if(myData.area > 0) {
    myData.resources.oil += Math.floor(myData.area / 500) + 1;
    myData.resources.iron += Math.floor(myData.area / 300) + 1;
  }
  if(tax > 20) myData.happiness = Math.max(0, myData.happiness - 2);
  else if(tax <= 10) myData.happiness = Math.min(100, myData.happiness + 1);
  if(myData.happiness >= 80) myData.population *= 1.02;
  else if(myData.happiness <= 20) myData.population *= 0.98;
  else myData.population *= 1.005;
  if(myData.warTarget) await autoWarProcess();
  refreshUI(); saveMe(myData);
 }

 async function autoWarProcess() {
  const db = await getDB();
  const enName = myData.warTarget;
  let en = db.nations[enName];
  if(!en) { myData.warTarget = null; return; }
  if(myData.military * (0.6 + Math.random()) > en.military * (0.6 + Math.random())) {
    en.military = Math.max(0, en.military - 100); myData.military = Math.max(0, myData.military - 50);
    if(en.geometries.length > 0) myData.geometries.push(en.geometries.pop());
    if(en.geometries.length === 0 || en.military <= 0) {
      alert(enName + " ã‚’ä½µåˆï¼");
      myData.money += en.money; delete db.nations[enName]; myData.warTarget = null;
    } else { db.nations[enName] = en; }
  } else { myData.military = Math.max(0, myData.military - 100); }
  db.nations[myName] = myData; await saveWorldDB(db);
 }

 function invest() { if(myData.money>=2000){myData.money-=2000; myData.gdp+=500; refreshUI(); saveMe(myData);} }
 function recruit() { if(myData.money>=1000 && myData.population>=500){myData.money-=1000; myData.population-=500; myData.military+=250; refreshUI(); saveMe(myData);} }
 function draftSoldiers() { if(confirm("å¼·åˆ¶å¾´å…µ?")){ if(myData.population>=2000){myData.population-=2000; myData.military+=2000; myData.happiness=Math.max(0,myData.happiness-20); refreshUI(); saveMe(myData);} } }
 function sellResources() { const earn = (myData.resources.oil*100)+(myData.resources.iron*50); if(earn>0){myData.money+=earn; myData.resources.oil=0; myData.resources.iron=0; refreshUI(); saveMe(myData); alert("å£²å´: "+earn);} }
 function printMoney() { if(confirm("é€šè²¨ç™ºè¡Œ?")){ myData.money+=10000; myData.happiness=Math.max(0,myData.happiness-5); refreshUI(); saveMe(myData); } }
  
 async function sendDM() {
   if(!selectedTarget) return;
   const m = prompt("å®›å…ˆ: " + selectedTarget + " ã¸ã®å¯†æ›¸:");
   if(m) {
     const db = await getDB();
     if(db.nations[selectedTarget]) { db.nations[selectedTarget].secretMsg = {from:myName, msg:m}; await saveWorldDB(db); alert("é€ä¿¡å®Œäº†"); }
   }
 }

 async function sendMoney() {
   if(!selectedTarget) return;
   const a = parseInt(prompt("é€é‡‘é¡:"));
   if(a > 0 && myData.money >= a) {
     myData.money -= a; const db = await getDB();
     if(db.nations[selectedTarget]) { db.nations[selectedTarget].money += a; db.nations[myName] = myData; await saveWorldDB(db); alert("é€é‡‘å®Œäº†"); }
   }
 }

 function startTransferGeo() { if(selectedTarget) { alert("è­²æ¸¡ãƒ¢ãƒ¼ãƒ‰é–‹å§‹"); transferMode = true; document.getElementById('mapMsg').innerText="ã€è­²æ¸¡ãƒ¢ãƒ¼ãƒ‰ã€‘ç›¸æ‰‹: "+selectedTarget; document.getElementById('mapMsg').style.display='block'; document.getElementById('cancelOverlay').style.display='block'; } }
 function manualSave() { saveMe(myData); alert("ä¿å­˜å®Œäº†"); }
 function doLogout() { localStorage.clear(); location.reload(); }
 function selectTarget(n) { selectedTarget = n; document.getElementById('targetName').innerText = n; document.querySelectorAll('#tab-war button').forEach(b=>b.disabled=false); }
 async function actionAlly() { if(!selectedTarget)return; const db = await getDB(); if(!db.nations[selectedTarget].requests) db.nations[selectedTarget].requests=[]; if(!db.nations[selectedTarget].requests.includes(myName)){db.nations[selectedTarget].requests.push(myName); await saveWorldDB(db); alert("ç”³è«‹å®Œäº†");} }
 async function acceptRequest(s) { myData.requests=myData.requests.filter(r=>r!==s); myData.allies.push(s); const db=await getDB(); if(db.nations[s]){ if(!db.nations[s].allies)db.nations[s].allies=[]; db.nations[s].allies.push(myName); db.nations[myName]=myData; await saveWorldDB(db); syncWorld(); alert("åŒç›Ÿæˆç«‹: "+s);} }
 async function actionWar() { if(confirm(selectedTarget+" ã«å®£æˆ¦å¸ƒå‘Š?")){ myData.warTarget=selectedTarget; saveMe(myData); } }

 function refreshUI() {
  if(isSpectator) return;
  document.getElementById('valMoney').innerText = Math.floor(myData.money).toLocaleString();
  document.getElementById('valArea').innerText = (myData.area || 0).toLocaleString();
  document.getElementById('valGDP').innerText = Math.floor(myData.gdp).toLocaleString();
  document.getElementById('valMil').innerText = Math.floor(myData.military).toLocaleString();
  document.getElementById('valPop').innerText = Math.floor(myData.population || 0).toLocaleString();
  document.getElementById('uiName').innerText = myName;
  document.getElementById('uiCurrency').innerText = myData.currency || "$";
  document.getElementById('uiCurrency2').innerText = myData.currency || "$";
  document.getElementById('valHappy').innerText = myData.happiness;
  document.getElementById('valOil').innerText = myData.resources.oil;
  document.getElementById('valIron').innerText = myData.resources.iron;
  document.getElementById('valUpkeep').innerText = "-" + (myData.military * 2).toLocaleString();
  const rb = document.getElementById('requestBox');
  rb.innerHTML = (myData.requests && myData.requests.length > 0) ? "" : "ç”³è«‹ãªã—";
  (myData.requests || []).forEach(s => { rb.innerHTML += `<div>${s} <button class="admin-edit-btn" onclick="acceptRequest('${s}')">æ‰¿è«¾</button></div>`; });
 }
  
 async function updateRanking(dbParam) {
  const db = dbParam || await getDB();
  const ranks = Object.keys(db.nations).map(k => {
   const n = db.nations[k]; 
   const s = Math.floor(n.gdp + (n.military * 10) + (n.area / 100));
   return { name: k, score: s };
  }).sort((a, b) => b.score - a.score);
  const list = document.getElementById('rankingList'); list.innerHTML = "";
  ranks.slice(0, 10).forEach((r, i) => { list.innerHTML += `<div class="rank-item"><span class="rank-num">${i+1}</span><span>${r.name}</span><span style="margin-left:auto">${r.score.toLocaleString()}</span></div>`; });
 }

 function attemptAdminLogin() { if(document.getElementById('adminKey').value === "201305042020302") { document.getElementById('adminPanel').classList.remove('hidden'); refreshAdminList(); } }
 function closeAdmin() { document.getElementById('adminPanel').classList.add('hidden'); }
 async function refreshAdminList() {
  const t = document.getElementById('adminTableBody'); t.innerHTML = ""; const db = await getDB();
  Object.keys(db.nations).forEach(k => {
   const n = db.nations[k];
   t.innerHTML += `<tr><td>${k}</td><td>${n.money} <button class="admin-edit-btn" onclick="adminEdit('${k}','money',${n.money})">å¤‰</button></td><td>${n.happiness}</td><td>${n.population}</td><td>${n.area}</td><td>${n.gdp}</td><td><button onclick="del('${k}')" style="background:red">æ¶ˆ</button></td></tr>`;
  });
 }
 async function adminEdit(c,k,v){ let n=prompt("å¤‰æ›´å¾Œ",v); if(n!==null){ const db=await getDB(); db.nations[c][k]=Number(n); await saveWorldDB(db); refreshAdminList(); }}
 async function del(n){ if(confirm("å‰Šé™¤?")){ const db=await getDB(); delete db.nations[n]; await saveWorldDB(db); refreshAdminList(); }}

 let flagCtx, fCur="#fff", fDraw=false;
 function initFlagEditor() {
  const c = document.getElementById('flagCanvas'); flagCtx = c.getContext('2d');
  if(myData.flag) { const i=new Image(); i.onload=()=>flagCtx.drawImage(i,0,0); i.src=myData.flag; } else { flagCtx.fillStyle="#fff"; flagCtx.fillRect(0,0,100,60); }
  const pal = document.getElementById('paletteBox'); pal.innerHTML="";
  ['#000','#fff','#f00','#0f0','#00f','#ff0','#0ff','#f0f'].forEach(col => { const d = document.createElement('div'); d.className='color-dot'; d.style.background=col; d.onclick=()=>fCur=col; pal.appendChild(d); });
  c.onmousedown=e=>{ fDraw=true; drawF(e); }; c.onmousemove=e=>{ if(fDraw) drawF(e); }; c.onmouseup=()=>fDraw=false;
 }
 function drawF(e) { const r=document.getElementById('flagCanvas').getBoundingClientRect(); flagCtx.fillStyle=fCur; flagCtx.fillRect(Math.floor((e.clientX-r.left)/10)*10, Math.floor((e.clientY-r.top)/10)*10, 10, 10); }
 function clearFlag() { flagCtx.fillStyle="#fff"; flagCtx.fillRect(0,0,100,60); }
 async function saveFlag() { myData.flag = document.getElementById('flagCanvas').toDataURL(); saveMe(myData); alert("ä¿å­˜"); }

 window.onkeydown = e => { if(e.shiftKey && e.altKey) document.getElementById('overlayAdminAuth').classList.remove('hidden'); };
 window.onload = () => { const n=localStorage.getItem('autoName'), p=localStorage.getItem('autoPass'); if(n && p) login(n,p); };
</script>
</body>
</html>
