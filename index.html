<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ãƒœãƒ¼ãƒ€ãƒ¼ãƒ©ã‚¤ãƒ³ãƒ»ã‚¹ãƒˆãƒ©ãƒ†ã‚¸ãƒ¼: Apex JP</title>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
 :root { --p: #00f3ff; --p-g: rgba(0, 243, 255, 0.3); --d: #ff0055; --s: #00ff99; --g: #ffcc00; --bg: #02050a; --panel: rgba(8, 15, 25, 0.96); }
 body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Noto Sans JP', 'Rajdhani', sans-serif; color: #e0e6ed; touch-action: none; }
 canvas { display: block; image-rendering: pixelated; }

 .glass { background: var(--panel); backdrop-filter: blur(20px); border: 1px solid rgba(0, 243, 255, 0.2); border-radius: 2px; }
 #side-panel { position: fixed; top: 10px; left: 10px; width: 320px; max-height: calc(100vh - 20px); z-index: 100; overflow-y: auto; padding: 20px; box-sizing: border-box; }
 #top-hud { position: fixed; top: 10px; left: 340px; right: 10px; height: 50px; z-index: 90; display: flex; align-items: center; padding: 0 20px; gap: 20px; border-bottom: 2px solid var(--p); }
 #mini-map-box { position: fixed; bottom: 20px; left: 20px; width: 160px; height: 160px; z-index: 100; border: 1px solid var(--p); background: #000; pointer-events: none; }
 #chat-box { position: fixed; bottom: 20px; right: 20px; width: 320px; height: 380px; z-index: 100; display: flex; flex-direction: column; transform: translateY(400px); transition: 0.4s; }
 #chat-box.active { transform: translateY(0); }

 h1, h2 { font-family: 'Orbitron', 'Noto Sans JP'; color: var(--p); margin: 0 0 15px; font-size: 1.1em; letter-spacing: 1px; }
 .row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9em; border-bottom: 1px solid rgba(255,255,255,0.05); }
 .lbl { color: #888; font-size: 0.75em; }
 .val { color: #fff; font-weight: bold; }
 
 button { width: 100%; padding: 10px; margin-bottom: 8px; border: 1px solid var(--p); background: rgba(0, 243, 255, 0.05); color: #fff; cursor: pointer; font-family: 'Noto Sans JP'; font-weight: bold; transition: 0.2s; }
 button:hover { background: var(--p); color: #000; box-shadow: 0 0 15px var(--p-g); }
 .btn-war { border-color: var(--d); color: var(--d); }
 .btn-war:hover { background: var(--d); color: #fff; }

 .tabs { display: flex; gap: 2px; margin-bottom: 15px; }
 .tab { flex: 1; padding: 8px; font-size: 0.75em; text-align: center; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); }
 .tab.active { border-color: var(--p); color: var(--p); background: rgba(0,243,255,0.1); }

 #messages { flex: 1; overflow-y: auto; padding: 10px; font-size: 0.8em; background: rgba(0,0,0,0.3); }
 #chat-in { background: #000; border: none; border-top: 1px solid var(--p); padding: 12px; color: #fff; outline: none; }

 .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #03070b; z-index: 2000; display: flex; align-items: center; justify-content: center; }
 input { width: 100%; padding: 12px; background: #000; border: 1px solid var(--p); color: #fff; margin-bottom: 10px; box-sizing: border-box; }

 #admin-panel { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; height: 80%; z-index: 3000; padding: 30px; display: none; background: #000; border: 2px solid var(--d); color: var(--d); }
 
 #flag-canvas { border: 1px solid #555; cursor: crosshair; background: #fff; display: block; margin: 10px auto; touch-action: none; }
 #info-popup { position: fixed; top: 70px; right: 20px; width: 200px; padding: 15px; z-index: 150; display: none; text-align: center; }
 .flag-img { width: 100px; height: 60px; border: 1px solid #333; margin-bottom: 10px; object-fit: cover; }
 .hidden { display: none !important; }
</style>
</head>
<body>

<div id="auth-screen" class="overlay">
 <div class="glass" style="padding:40px; width:340px;">
  <h1>å¸ä»¤éƒ¨: å›½å®¶æ‰¿èª</h1>
  <input type="text" id="auth-name" placeholder="å›½å®¶åã‚’å…¥åŠ›">
  <input type="password" id="auth-pass" placeholder="ã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
  <div class="lbl" style="margin-bottom:5px;">å›½å®¶ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚«ãƒ©ãƒ¼</div>
  <input type="color" id="auth-color" value="#00f3ff" style="height:40px; border:none; background:none; cursor:pointer;">
  <button onclick="attemptAuth()">å»ºå›½ / ãƒ­ã‚°ã‚¤ãƒ³</button>
  <p id="auth-err" style="color:var(--d); font-size:0.8em; margin-top:10px;"></p>
 </div>
</div>

<div id="info-popup" class="glass">
 <div class="lbl" id="pop-nation-name">å›½å®¶å</div>
 <img id="pop-flag" class="flag-img" src="" alt="å›½æ——">
 <div id="pop-stats" style="font-size:0.7em;"></div>
</div>

<div id="admin-panel" class="glass">
 <h2>ç®¡ç†è€…ç”¨ã‚¿ãƒ¼ãƒŸãƒŠãƒ«</h2>
 <button onclick="document.getElementById('admin-panel').style.display='none'">é–‰ã˜ã‚‹</button>
 <div id="admin-list"></div>
</div>

<div id="top-hud" class="glass hidden">
 <div style="display:flex; gap:20px; font-size:0.85em;">
  <div>çŸ³æ²¹: <span id="ui-oil" style="color:var(--g)">0</span></div>
  <div>é‰„é‹¼: <span id="ui-iron" style="color:var(--g)">0</span></div>
  <div>é»„é‡‘: <span id="ui-gold" style="color:var(--g)">0</span></div>
 </div>
 <div id="ui-sys-msg" style="flex:1; text-align:center; color:var(--p); font-size:0.75em; letter-spacing:1px;">ã‚·ã‚¹ãƒ†ãƒ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</div>
 <div style="font-size:0.7em;">åº§æ¨™: <span id="ui-coord">0,0</span></div>
</div>

<div id="side-panel" class="glass hidden">
 <h1 id="ui-my-name">å›½å®¶</h1>
 <div class="row"><span class="lbl">è³‡é‡‘ (Credits)</span><span class="val" id="ui-money">0</span></div>
 <div class="row"><span class="lbl">äººå£</span><span class="val" id="ui-pop">0</span></div>
 <div class="row"><span class="lbl">é ˜åœŸé¢ç©</span><span class="val" id="ui-area">0</span></div>
 <div class="row"><span class="lbl">å›½æ°‘å¹¸ç¦åº¦</span><span class="val" id="ui-happy">100</span>%</div>
 
 <div class="tabs">
  <div class="tab active" onclick="setTab('eco')">å†…æ”¿</div>
  <div class="tab" onclick="setTab('mil')">è»äº‹</div>
  <div class="tab" onclick="setTab('dip')">å¤–äº¤</div>
  <div class="tab" onclick="setTab('flg')">å›½æ——</div>
 </div>

 <div id="tab-eco">
  <div class="lbl">æ‰€å¾—ç¨ç‡: <span id="tax-v">10</span>%</div>
  <input type="range" id="tax-s" min="0" max="60" value="10" oninput="document.getElementById('tax-v').innerText=this.value">
  <button onclick="action('gdp')">ğŸ­ ç”£æ¥­æŠ•è³‡ (-5000)</button>
  <button onclick="action('aid')">ğŸ ç¤¾ä¼šç¦ç¥‰çµ¦ä»˜ (-10000)</button>
  <div id="ui-upkeep" style="font-size:0.7em; color:var(--d); text-align:right;"></div>
 </div>

 <div id="tab-mil" class="hidden">
  <div class="lbl">è»äº‹åŠ›: <span id="ui-mil" class="val">0</span></div>
  <button class="btn-war" onclick="action('recruit')">âš”ï¸ å…µå“¡é›‡ç”¨ (-3000)</button>
  <button class="btn-war" onclick="action('draft')">ğŸ“¢ å¼·åˆ¶å¾´å…µ (ç„¡æ–™ / å¹¸ç¦åº¦æ¿€æ¸›)</button>
  <button onclick="action('fortify')">ğŸ›¡ï¸ é˜²è¡›ç·šå¼·åŒ– (-10000 / é‰„é‹¼-50)</button>
 </div>

 <div id="tab-dip" class="hidden">
  <div id="ui-target-box" class="glass" style="padding:10px; margin-bottom:10px; border-color:var(--d);">
   <div class="lbl">é¸æŠä¸­ã®å›½å®¶:</div>
   <div id="ui-target-name" class="val">ãªã—</div>
   <div style="display:flex; gap:5px; margin-top:5px;">
    <button style="font-size:0.6em;" onclick="action('dm')">å¯†æ›¸</button>
    <button style="font-size:0.6em;" onclick="action('send_money')">é€é‡‘</button>
   </div>
  </div>
  <div class="lbl">ä¸–ç•Œé ˜åœŸãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
  <div id="rank-list"></div>
 </div>

 <div id="tab-flg" class="hidden">
  <div class="lbl">å›½æ——ãƒ‡ã‚¶ã‚¤ãƒ³ (10x6)</div>
  <canvas id="flag-canvas" width="100" height="60"></canvas>
  <div style="display:flex; gap:4px; flex-wrap:wrap; justify-content:center;" id="flag-palette"></div>
  <button onclick="saveFlag()" style="margin-top:10px;" class="btn-eco">å›½æ——ã‚’ä¿å­˜ãƒ»æ›´æ–°</button>
  <p style="font-size:0.6em; color:#888; text-align:center;">é ˜åœŸã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
 </div>
 
 <button onclick="saveManual()" style="margin-top:20px; font-size:0.6em; opacity:0.5;">æ‰‹å‹•ã‚µãƒ¼ãƒãƒ¼åŒæœŸ</button>
</div>

<div id="mini-map-box" class="hidden"><canvas id="mini-map-canvas"></canvas></div>

<button id="chat-toggle" style="position:fixed; bottom:20px; right:20px; z-index:110; width:50px; height:50px; background:var(--p); border:none; cursor:pointer;" onclick="document.getElementById('chat-box').classList.toggle('active')">ğŸ’¬</button>
<div id="chat-box" class="glass">
 <div id="messages"></div>
 <input type="text" id="chat-in" placeholder="é€šä¿¡å†…å®¹ã‚’å…¥åŠ›...">
</div>

<canvas id="gameCanvas"></canvas>

<script>
// --- CORE CONFIG ---
const PANTRY_ID = "6fafdf00-0e50-4e44-a7ee-21e3a266898c";
const PANTRY_URL = `https://getpantry.cloud/apiv1/pantry/${PANTRY_ID}/basket/apex_v5_jp`;

const gun = Gun(['https://gun-manhattan.herokuapp.com/gun', 'https://relay.peers.gun.eco/gun']);
const db = gun.get('borderline_apex_v5_jp');
const pixelDB = db.get('world');
const nationDB = db.get('nations');
const chatDB = db.get('chat');

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', { alpha: false });
const miniCanvas = document.getElementById('mini-map-canvas');
const miniCtx = miniCanvas.getContext('2d');

let me = {
 name: "", pass: "", color: "#00f3ff", money: 50000, pop: 10000, 
 happy: 100, mil: 100, area: 0, gdp: 1500, oil: 100, iron: 100, gold: 0, fort: 1, flag: null
};

let world = {}; 
let nations = {};
let camX=0, camY=0, zoom=25, isPainting=false, isDragging=false, lastMouse={x:0,y:0}, selectedTarget=null;

// --- AUTH ---
async function attemptAuth() {
 const name = document.getElementById('auth-name').value.trim();
 const pass = document.getElementById('auth-pass').value;
 const col = document.getElementById('auth-color').value;
 if(!name || !pass) {
    document.getElementById('auth-err').innerText = "å›½å®¶åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
    return;
 }

 nationDB.get(name).once((data) => {
  if(data && data.pass !== pass) {
   document.getElementById('auth-err').innerText = "èªè¨¼å¤±æ•—: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";
   return;
  }
  me = {...me, ...data, name, pass, color: (data ? data.color : col)};
  init();
 });
}

async function init() {
 document.getElementById('auth-screen').classList.add('hidden');
 ['side-panel', 'top-hud', 'mini-map-box'].forEach(id => document.getElementById(id).classList.remove('hidden'));
 document.getElementById('ui-my-name').innerText = me.name;

 pixelDB.map().on((v, k) => { if(v) world[k] = v; else delete world[k]; });
 nationDB.map().on((v, k) => { if(v) { 
  nations[k] = v;
  if(k === me.name && v.dm && v.dm.to === me.name) {
    alert(`ã€æ¥µç§˜é€šä¿¡ã€‘é€ä¿¡å…ƒ ${v.dm.from}: ${v.dm.msg}`);
    nationDB.get(me.name).get('dm').put(null);
  }
 }});
 chatDB.map().on((d, i) => { if(d && Date.now()-i < 3600000) addMsg(d.n, d.t, d.c); });

 await loadBackup();
 initFlagEditor();
 setInterval(gameLoop, 3000);
 setInterval(saveBackup, 60000);
 render();
}

// --- GAME ENGINE ---
function gameLoop() {
 const tax = parseInt(document.getElementById('tax-s').value);
 
 // çµŒæ¸ˆè¨ˆç®—
 const income = (me.gdp * (tax/100)) + (me.area * 5);
 const upkeep = (me.mil * 1.5) + (me.fort * 200);
 me.money += (income - upkeep);

 // è³‡æºç”Ÿç”£
 me.oil += Math.floor(me.area / 10);
 me.iron += Math.floor(me.area / 15);
 if(me.area > 1000) me.gold += 1;

 // å¹¸ç¦åº¦ã¨äººå£
 if(tax > 30) me.happy -= 2; else if(tax < 15) me.happy += 1;
 if(me.money < 0) { me.money = 0; me.mil = Math.max(0, me.mil-20); me.happy -= 5; }
 me.happy = Math.min(100, Math.max(0, me.happy));

 if(me.happy > 80) me.pop += Math.floor(me.pop * 0.01);
 else if(me.happy < 20) me.pop -= Math.floor(me.pop * 0.01);

 me.area = Object.values(world).filter(n => n === me.name).length;
 
 updateUI();
 document.getElementById('ui-upkeep').innerText = `ç¶­æŒè²»: -${Math.floor(upkeep)}`;
 nationDB.get(me.name).put(me);
}

function action(type) {
 if(type === 'gdp' && me.money >= 5000) { me.money -= 5000; me.gdp += 1000; }
 if(type === 'aid' && me.money >= 10000) { me.money -= 10000; me.happy = Math.min(100, me.happy + 30); }
 if(type === 'recruit' && me.money >= 3000 && me.pop >= 300) { me.money -= 3000; me.pop -= 300; me.mil += 400; }
 if(type === 'draft') { me.happy -= 40; me.mil += 2000; }
 if(type === 'fortify' && me.money >= 10000 && me.iron >= 50) { me.money -= 10000; me.iron -= 50; me.fort += 1; }
 if(type === 'send_money' && selectedTarget) {
  let amt = parseInt(prompt(`${selectedTarget}ã¸ã®é€é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`));
  if(amt > 0 && me.money >= amt) {
    me.money -= amt;
    nationDB.get(selectedTarget).get('money').once(v => nationDB.get(selectedTarget).put({money: (v||0)+amt}));
    alert("é€é‡‘ãŒå®Œäº†ã—ã¾ã—ãŸ");
  }
 }
 if(type === 'dm' && selectedTarget) {
  let m = prompt(`${selectedTarget}ã¸ã®æ¥µç§˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›:`);
  if(m) nationDB.get(selectedTarget).get('dm').put({from: me.name, to: selectedTarget, msg: m});
 }
 updateUI();
}

// --- RENDER ---
function render() {
 canvas.width = window.innerWidth; canvas.height = window.innerHeight;
 ctx.fillStyle = '#02050a'; ctx.fillRect(0,0,canvas.width,canvas.height);
 const sw = toWorld(0,0); const ew = toWorld(canvas.width, canvas.height);

 // ã‚°ãƒªãƒƒãƒ‰
 ctx.beginPath(); ctx.strokeStyle = "rgba(0, 243, 255, 0.04)";
 for(let x=sw.wx; x<=ew.wx; x++) { let p = toScreen(x,0); ctx.moveTo(p.x,0); ctx.lineTo(p.x,canvas.height); }
 for(let y=sw.wy; y<=ew.wy; y++) { let p = toScreen(0,y); ctx.moveTo(0,p.y); ctx.lineTo(canvas.width,p.y); }
 ctx.stroke();

 // é ˜åœŸæç”»
 for(let pos in world) {
  const [wx, wy] = pos.split('_').map(Number);
  if(wx < sw.wx || wx > ew.wx || wy < sw.wy || wy > ew.wy) continue;
  const info = nations[world[pos]];
  if(!info) continue;
  const s = toScreen(wx, wy);
  ctx.fillStyle = info.color;
  ctx.globalAlpha = 0.8;
  ctx.fillRect(s.x, s.y, Math.ceil(zoom), Math.ceil(zoom));
 }
 ctx.globalAlpha = 1.0;
 drawMinimap();
 requestAnimationFrame(render);
}

function claim(wx, wy) {
 const key = `${wx}_${wy}`;
 const target = world[key];
 if(target === me.name) return;

 let cost = 10;
 if(target) {
  if(me.mil < 10) return;
  me.mil -= 4; cost = 120;
  const tInfo = nations[target];
  if(tInfo && tInfo.fort) cost += (tInfo.fort * 20);
 }

 if(me.money >= cost) {
  me.money -= cost;
  world[key] = me.name;
  pixelDB.get(key).put(me.name);
  updateUI();
 }
}

// --- MINIMAP ---
function drawMinimap() {
 miniCanvas.width = 160; miniCanvas.height = 160;
 miniCtx.fillStyle = "#000"; miniCtx.fillRect(0,0,160,160);
 for(let pos in world) {
  const [wx, wy] = pos.split('_').map(Number);
  const info = nations[world[pos]];
  if(info) {
   miniCtx.fillStyle = info.color;
   miniCtx.fillRect(80 + wx/2, 80 + wy/2, 1, 1);
  }
 }
 miniCtx.strokeStyle = "#fff";
 miniCtx.strokeRect(80 + (camX/2) - 4, 80 + (camY/2) - 4, 8, 8);
}

// --- FLAG EDITOR ---
let fCtx, fColor = "#000";
function initFlagEditor() {
 const c = document.getElementById('flag-canvas'); fCtx = c.getContext('2d');
 if(me.flag) { let i = new Image(); i.onload = () => fCtx.drawImage(i,0,0); i.src = me.flag; }
 else { fCtx.fillStyle = "#fff"; fCtx.fillRect(0,0,100,60); }
 const p = document.getElementById('flag-palette');
 p.innerHTML = "";
 ["#000","#fff","#f00","#0f0","#00f","#ff0","#f0f","#0ff","#888","#444"].forEach(col => {
  let d = document.createElement('div'); d.style.width="24px"; d.style.height="24px"; d.style.background=col; d.style.border="1px solid #555"; d.onclick=()=>fColor=col; p.appendChild(d);
 });
 c.onmousedown = (e) => {
  const rect = c.getBoundingClientRect();
  fCtx.fillStyle = fColor;
  fCtx.fillRect(Math.floor((e.clientX-rect.left)/10)*10, Math.floor((e.clientY-rect.top)/10)*10, 10, 10);
 };
}
function saveFlag() { me.flag = document.getElementById('flag-canvas').toDataURL(); alert("å›½æ——ã‚’ä¿å­˜ã—ã¾ã—ãŸ"); nationDB.get(me.name).put(me); }

// --- CONTROLS ---
canvas.onmousedown = (e) => {
 if(e.button===0) isPainting=true; else isDragging=true;
 lastMouse = {x: e.clientX, y: e.clientY};
 if(isPainting) { const w = toWorld(e.clientX, e.clientY); claim(w.wx, w.wy); }
};
window.onmousemove = (e) => {
 const w = toWorld(e.clientX, e.clientY);
 document.getElementById('ui-coord').innerText = `${w.wx},${w.wy}`;
 if(isPainting) claim(w.wx, w.wy);
 if(isDragging) {
  camX -= (e.clientX - lastMouse.x)/zoom;
  camY -= (e.clientY - lastMouse.y)/zoom;
  lastMouse = {x: e.clientX, y: e.clientY};
 }
 const target = world[w.wx + "_" + w.wy];
 if(target) {
  selectedTarget = target;
  document.getElementById('ui-target-name').innerText = target;
  document.getElementById('ui-target-name').style.color = nations[target]?.color || "#fff";
  
  // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
  const pop = document.getElementById('info-popup');
  pop.style.display = 'block';
  document.getElementById('pop-nation-name').innerText = target;
  document.getElementById('pop-nation-name').style.color = nations[target]?.color || "#fff";
  document.getElementById('pop-flag').src = nations[target]?.flag || "";
  document.getElementById('pop-stats').innerText = `é¢ç©: ${nations[target]?.area || 0} / è»äº‹: ${nations[target]?.mil || 0}`;
 } else {
  document.getElementById('info-popup').style.display = 'none';
 }
};
window.onmouseup = () => { isPainting = false; isDragging = false; };
canvas.onwheel = (e) => { e.preventDefault(); zoom = Math.min(Math.max(zoom * (e.deltaY>0?0.85:1.15), 4), 150); };

// --- ADMIN ---
window.onkeydown = (e) => {
 if(e.shiftKey && e.altKey && e.code === "KeyA") {
  if(prompt("ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„") === "20130504") {
   document.getElementById('admin-panel').style.display = 'block';
   refreshAdmin();
  }
 }
};
function refreshAdmin() {
 const l = document.getElementById('admin-list'); l.innerHTML = "";
 Object.entries(nations).forEach(([name, data]) => {
  l.innerHTML += `<div>${name} - è³‡é‡‘: ${data.money} <button onclick="nationDB.get('${name}').put({money:1000000})">è³‡é‡‘è¿½åŠ </button> <button onclick="nationDB.get('${name}').put(null); alert('å‰Šé™¤ã—ã¾ã—ãŸ');">å‰Šé™¤</button></div>`;
 });
}

// --- SYNC & UI ---
function toScreen(wx,wy) { return {x:(wx-camX)*zoom+canvas.width/2, y:(wy-camY)*zoom+canvas.height/2}; }
function toWorld(sx,sy) { return {wx:Math.floor((sx-canvas.width/2)/zoom+camX), wy:Math.floor((sy-canvas.height/2)/zoom+camY)}; }
function setTab(t) {
 ['eco','mil','dip','flg'].forEach(id => document.getElementById('tab-'+id).classList.add('hidden'));
 document.getElementById('tab-'+t).classList.remove('hidden');
 document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
 event.target.classList.add('active');
 if(t==='dip') refreshRank();
 if(t==='flg') initFlagEditor();
}
function updateUI() {
 document.getElementById('ui-money').innerText = Math.floor(me.money).toLocaleString();
 document.getElementById('ui-pop').innerText = Math.floor(me.pop).toLocaleString();
 document.getElementById('ui-area').innerText = me.area.toLocaleString();
 document.getElementById('ui-happy').innerText = me.happy;
 document.getElementById('ui-mil').innerText = Math.floor(me.mil).toLocaleString();
 document.getElementById('ui-oil').innerText = me.oil;
 document.getElementById('ui-iron').innerText = me.iron;
 document.getElementById('ui-gold').innerText = me.gold;
}
function addMsg(n, t, c) {
 const m = document.getElementById('messages');
 const d = document.createElement('div'); d.innerHTML = `<b style="color:${c}">${n}:</b> ${t}`;
 m.appendChild(d); m.scrollTop = m.scrollHeight;
}
document.getElementById('chat-in').onkeypress = (e) => {
 if(e.key==='Enter' && e.target.value) { chatDB.get(Date.now()).put({n:me.name, t:e.target.value, c:me.color}); e.target.value = ""; }
};
function refreshRank() {
 const r = document.getElementById('rank-list');
 const sorted = Object.entries(nations).sort((a,b) => (b[1].area||0) - (a[1].area||0));
 r.innerHTML = sorted.slice(0, 10).map(([name, n], i) => `<div class="row"><span>${i+1}. ${name}</span><span style="color:${n.color}">${n.area||0}</span></div>`).join('');
}
async function saveBackup() { try { await fetch(PANTRY_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ world, nations }) }); } catch(e){} }
async function loadBackup() { try { const res = await fetch(PANTRY_URL); if(res.ok) { const d = await res.json(); if(d.world) world = d.world; if(d.nations) nations = d.nations; } } catch(e){} }
function saveManual() { nationDB.get(me.name).put(me); alert("æ‰‹å‹•åŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸ"); }
</script>
</body>
</html>
