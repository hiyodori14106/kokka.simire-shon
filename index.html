<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Borderline Strategy: Apex</title>
<script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
 :root { --p: #00f3ff; --p-g: rgba(0, 243, 255, 0.3); --d: #ff0055; --s: #00ff99; --g: #ffcc00; --bg: #02050a; --panel: rgba(8, 15, 25, 0.96); }
 body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Rajdhani', 'Noto Sans JP', sans-serif; color: #e0e6ed; touch-action: none; }
 canvas { display: block; image-rendering: pixelated; }

 /* UI Containers */
 .glass { background: var(--panel); backdrop-filter: blur(20px); border: 1px solid rgba(0, 243, 255, 0.2); border-radius: 2px; }
 #side-panel { position: fixed; top: 10px; left: 10px; width: 320px; max-height: calc(100vh - 20px); z-index: 100; overflow-y: auto; padding: 20px; box-sizing: border-box; }
 #top-hud { position: fixed; top: 10px; left: 340px; right: 10px; height: 50px; z-index: 90; display: flex; align-items: center; padding: 0 20px; gap: 20px; border-bottom: 2px solid var(--p); }
 #mini-map-box { position: fixed; bottom: 20px; left: 20px; width: 160px; height: 160px; z-index: 100; border: 1px solid var(--p); background: #000; pointer-events: none; }
 #chat-box { position: fixed; bottom: 20px; right: 20px; width: 320px; height: 380px; z-index: 100; display: flex; flex-direction: column; transform: translateY(400px); transition: 0.4s; }
 #chat-box.active { transform: translateY(0); }

 /* General UI */
 h1, h2 { font-family: 'Orbitron'; color: var(--p); margin: 0 0 15px; font-size: 1.1em; letter-spacing: 2px; }
 .row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9em; border-bottom: 1px solid rgba(255,255,255,0.05); }
 .lbl { color: #888; font-size: 0.75em; text-transform: uppercase; }
 .val { color: #fff; font-weight: bold; }
 
 button { width: 100%; padding: 10px; margin-bottom: 8px; border: 1px solid var(--p); background: rgba(0, 243, 255, 0.05); color: #fff; cursor: pointer; font-family: 'Rajdhani'; font-weight: bold; font-size: 0.9em; transition: 0.2s; }
 button:hover { background: var(--p); color: #000; box-shadow: 0 0 15px var(--p-g); }
 .btn-war { border-color: var(--d); color: var(--d); }
 .btn-war:hover { background: var(--d); color: #fff; }

 .tabs { display: flex; gap: 2px; margin-bottom: 15px; }
 .tab { flex: 1; padding: 8px; font-size: 0.7em; text-align: center; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); }
 .tab.active { border-color: var(--p); color: var(--p); background: rgba(0,243,255,0.1); }

 #messages { flex: 1; overflow-y: auto; padding: 10px; font-size: 0.8em; background: rgba(0,0,0,0.3); }
 #chat-in { background: #000; border: none; border-top: 1px solid var(--p); padding: 12px; color: #fff; outline: none; }

 .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #03070b; z-index: 2000; display: flex; align-items: center; justify-content: center; }
 input { width: 100%; padding: 10px; background: #000; border: 1px solid var(--p); color: #fff; margin-bottom: 10px; box-sizing: border-box; }

 #admin-panel { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; height: 80%; z-index: 3000; padding: 30px; overflow-y: auto; display: none; background: #000; border: 2px solid var(--d); color: var(--d); }
 
 /* Flag Canvas */
 #flag-canvas { border: 1px solid #555; cursor: crosshair; background: #fff; display: block; margin: 10px auto; }
 .hidden { display: none !important; }
</style>
</head>
<body>

<div id="auth-screen" class="overlay">
 <div class="glass" style="padding:40px; width:340px;">
  <h1>HQ: IDENTIFICATION</h1>
  <input type="text" id="auth-name" placeholder="NATION NAME">
  <input type="password" id="auth-pass" placeholder="SECURITY KEY">
  <input type="color" id="auth-color" value="#00f3ff" style="height:40px; border:none; background:none;">
  <button onclick="attemptAuth()">LOGIN / ESTABLISH</button>
  <p id="auth-err" style="color:var(--d); font-size:0.8em; margin-top:10px;"></p>
 </div>
</div>

<div id="admin-panel" class="glass">
 <h2>TERMINAL: ADMIN OVERRIDE</h2>
 <button onclick="document.getElementById('admin-panel').style.display='none'">CLOSE</button>
 <div id="admin-list"></div>
</div>

<div id="top-hud" class="glass hidden">
 <div style="display:flex; gap:20px; font-family:'Orbitron'; font-size:0.8em;">
  <div>OIL: <span id="ui-oil" style="color:var(--g)">0</span></div>
  <div>IRON: <span id="ui-iron" style="color:var(--g)">0</span></div>
  <div>GOLD: <span id="ui-gold" style="color:var(--g)">0</span></div>
 </div>
 <div id="ui-sys-msg" style="flex:1; text-align:center; color:var(--p); font-size:0.7em;">SYSTEM ONLINE</div>
 <div style="font-size:0.7em;">COORD: <span id="ui-coord">0,0</span></div>
</div>

<div id="side-panel" class="glass hidden">
 <h1 id="ui-my-name">NATION</h1>
 <div class="row"><span class="lbl">CREDITS</span><span class="val" id="ui-money">0</span></div>
 <div class="row"><span class="lbl">POPULATION</span><span class="val" id="ui-pop">0</span></div>
 <div class="row"><span class="lbl">TERRITORY</span><span class="val" id="ui-area">0</span></div>
 <div class="row"><span class="lbl">HAPPINESS</span><span class="val" id="ui-happy">100</span>%</div>
 
 <div class="tabs">
  <div class="tab active" onclick="setTab('eco')">ECON</div>
  <div class="tab" onclick="setTab('mil')">MIL</div>
  <div class="tab" onclick="setTab('dip')">DIP</div>
  <div class="tab" onclick="setTab('flg')">FLAG</div>
 </div>

 <div id="tab-eco">
  <div class="lbl">TAX RATE: <span id="tax-v">10</span>%</div>
  <input type="range" id="tax-s" min="0" max="60" value="10" oninput="document.getElementById('tax-v').innerText=this.value">
  <button onclick="action('gdp')">üè≠ UPGRADE GDP (-5k)</button>
  <button onclick="action('aid')">üéÅ SOCIAL AID (-10k)</button>
  <div id="ui-upkeep" style="font-size:0.7em; color:var(--d); text-align:right;"></div>
 </div>

 <div id="tab-mil" class="hidden">
  <div class="lbl">MILITARY: <span id="ui-mil" class="val">0</span></div>
  <button class="btn-war" onclick="action('recruit')">‚öîÔ∏è RECRUIT UNITS (-3k)</button>
  <button class="btn-war" onclick="action('draft')">üì¢ FORCED DRAFT (FREE / HAPPY--)</button>
  <button onclick="action('fortify')">üõ°Ô∏è BORDER WALL (-10k / IRON-50)</button>
 </div>

 <div id="tab-dip" class="hidden">
  <div id="ui-target-box" class="glass" style="padding:10px; margin-bottom:10px; border-color:var(--d);">
   <div class="lbl">SELECTED TARGET:</div>
   <div id="ui-target-name" class="val">NONE</div>
   <div style="display:flex; gap:5px; margin-top:5px;">
    <button style="font-size:0.6em;" onclick="action('dm')">DM</button>
    <button style="font-size:0.6em;" onclick="action('send_money')">GIFT</button>
    <button style="font-size:0.6em;" onclick="action('ally')">ALLY</button>
   </div>
  </div>
  <div id="rank-list"></div>
 </div>

 <div id="tab-flg" class="hidden">
  <canvas id="flag-canvas" width="100" height="60"></canvas>
  <div style="display:flex; gap:2px; flex-wrap:wrap;" id="flag-palette"></div>
  <button onclick="saveFlag()" style="margin-top:10px;">SAVE FLAG</button>
 </div>
 
 <button onclick="saveManual()" style="margin-top:20px; font-size:0.6em; opacity:0.5;">FORCE SERVER SYNC</button>
</div>

<div id="mini-map-box" class="hidden"><canvas id="mini-map-canvas"></canvas></div>

<button id="chat-toggle" style="position:fixed; bottom:20px; right:20px; z-index:110; width:50px; height:50px; background:var(--p); border:none; cursor:pointer;" onclick="document.getElementById('chat-box').classList.toggle('active')">üí¨</button>
<div id="chat-box" class="glass">
 <div id="messages"></div>
 <input type="text" id="chat-in" placeholder="BROADCAST...">
</div>

<canvas id="gameCanvas"></canvas>

<script>
// --- CORE CONFIG ---
const PANTRY_ID = "6fafdf00-0e50-4e44-a7ee-21e3a266898c";
const PANTRY_URL = `https://getpantry.cloud/apiv1/pantry/${PANTRY_ID}/basket/apex_v5`;

const gun = Gun(['https://gun-manhattan.herokuapp.com/gun', 'https://relay.peers.gun.eco/gun']);
const db = gun.get('borderline_apex_v5');
const pixelDB = db.get('world');
const nationDB = db.get('nations');
const chatDB = db.get('chat');

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', { alpha: false });
const miniCanvas = document.getElementById('mini-map-canvas');
const miniCtx = miniCanvas.getContext('2d');

let me = {
 name: "", pass: "", color: "#00f3ff", money: 50000, pop: 10000, 
 happy: 100, mil: 100, area: 0, gdp: 1500, oil: 100, iron: 100, gold: 0, fort: 1, flag: null
};

let world = {}; 
let nations = {};
let camX=0, camY=0, zoom=25, isPainting=false, isDragging=false, lastMouse={x:0,y:0}, selectedTarget=null;

// --- AUTH ---
async function attemptAuth() {
 const name = document.getElementById('auth-name').value.trim();
 const pass = document.getElementById('auth-pass').value;
 const col = document.getElementById('auth-color').value;
 if(!name || !pass) return;

 nationDB.get(name).once((data) => {
  if(data && data.pass !== pass) {
   document.getElementById('auth-err').innerText = "WRONG PASSWORD";
   return;
  }
  me = {...me, ...data, name, pass, color: (data ? data.color : col)};
  init();
 });
}

async function init() {
 document.getElementById('auth-screen').classList.add('hidden');
 ['side-panel', 'top-hud', 'mini-map-box'].forEach(id => document.getElementById(id).classList.remove('hidden'));
 document.getElementById('ui-my-name').innerText = me.name;

 pixelDB.map().on((v, k) => { if(v) world[k] = v; else delete world[k]; });
 nationDB.map().on((v, k) => { if(v) { 
  nations[k] = v;
  if(k === me.name && v.dm && v.dm.to === me.name) {
    alert(`„ÄêSECRET DM„Äëfrom ${v.dm.from}: ${v.dm.msg}`);
    nationDB.get(me.name).get('dm').put(null);
  }
 }});
 chatDB.map().on((d, i) => { if(d && Date.now()-i < 3600000) addMsg(d.n, d.t, d.c); });

 await loadBackup();
 initFlagEditor();
 setInterval(gameLoop, 3000);
 setInterval(saveBackup, 60000);
 render();
}

// --- GAME ENGINE ---
function gameLoop() {
 const tax = parseInt(document.getElementById('tax-s').value);
 
 // Economy
 const income = (me.gdp * (tax/100)) + (me.area * 5);
 const upkeep = (me.mil * 1.5) + (me.fort * 200);
 me.money += (income - upkeep);

 // Resources
 me.oil += Math.floor(me.area / 10);
 me.iron += Math.floor(me.area / 15);
 if(me.area > 1000) me.gold += 1;

 // Happiness & Population
 if(tax > 30) me.happy -= 2; else if(tax < 15) me.happy += 1;
 if(me.money < 0) { me.money = 0; me.mil = Math.max(0, me.mil-20); me.happy -= 5; }
 me.happy = Math.min(100, Math.max(0, me.happy));

 if(me.happy > 80) me.pop += Math.floor(me.pop * 0.01);
 else if(me.happy < 20) me.pop -= Math.floor(me.pop * 0.01);

 me.area = Object.values(world).filter(n => n === me.name).length;
 
 updateUI();
 document.getElementById('ui-upkeep').innerText = `UPKEEP: -${Math.floor(upkeep)}`;
 nationDB.get(me.name).put(me);
}

function action(type) {
 if(type === 'gdp' && me.money >= 5000) { me.money -= 5000; me.gdp += 1000; }
 if(type === 'aid' && me.money >= 10000) { me.money -= 10000; me.happy = Math.min(100, me.happy + 30); }
 if(type === 'recruit' && me.money >= 3000 && me.pop >= 300) { me.money -= 3000; me.pop -= 300; me.mil += 400; }
 if(type === 'draft') { me.happy -= 40; me.mil += 2000; }
 if(type === 'fortify' && me.money >= 10000 && me.iron >= 50) { me.money -= 10000; me.iron -= 50; me.fort += 1; }
 if(type === 'send_money' && selectedTarget) {
  let amt = parseInt(prompt("AMOUNT TO SEND:"));
  if(amt > 0 && me.money >= amt) {
    me.money -= amt;
    nationDB.get(selectedTarget).get('money').once(v => nationDB.get(selectedTarget).put({money: (v||0)+amt}));
    alert("SENT");
  }
 }
 if(type === 'dm' && selectedTarget) {
  let m = prompt("SECRET MESSAGE:");
  if(m) nationDB.get(selectedTarget).get('dm').put({from: me.name, to: selectedTarget, msg: m});
 }
 updateUI();
}

// --- RENDER ---
function render() {
 canvas.width = window.innerWidth; canvas.height = window.innerHeight;
 ctx.fillStyle = '#02050a'; ctx.fillRect(0,0,canvas.width,canvas.height);
 const sw = toWorld(0,0); const ew = toWorld(canvas.width, canvas.height);

 // Grid
 ctx.beginPath(); ctx.strokeStyle = "rgba(0, 243, 255, 0.04)";
 for(let x=sw.wx; x<=ew.wx; x++) { let p = toScreen(x,0); ctx.moveTo(p.x,0); ctx.lineTo(p.x,canvas.height); }
 for(let y=sw.wy; y<=ew.wy; y++) { let p = toScreen(0,y); ctx.moveTo(0,p.y); ctx.lineTo(canvas.width,p.y); }
 ctx.stroke();

 // Draw world
 for(let pos in world) {
  const [wx, wy] = pos.split('_').map(Number);
  if(wx < sw.wx || wx > ew.wx || wy < sw.wy || wy > ew.wy) continue;
  const info = nations[world[pos]];
  if(!info) continue;
  const s = toScreen(wx, wy);
  ctx.fillStyle = info.color;
  ctx.globalAlpha = 0.8;
  ctx.fillRect(s.x, s.y, Math.ceil(zoom), Math.ceil(zoom));
 }
 ctx.globalAlpha = 1.0;
 drawMinimap();
 requestAnimationFrame(render);
}

function claim(wx, wy) {
 const key = `${wx}_${wy}`;
 const target = world[key];
 if(target === me.name) return;

 let cost = 10;
 if(target) {
  if(me.mil < 10) return;
  me.mil -= 4; cost = 120;
  const tInfo = nations[target];
  if(tInfo && tInfo.fort) cost += (tInfo.fort * 20);
 }

 if(me.money >= cost) {
  me.money -= cost;
  world[key] = me.name;
  pixelDB.get(key).put(me.name);
  updateUI();
 }
}

// --- MINIMAP ---
function drawMinimap() {
 miniCanvas.width = 160; miniCanvas.height = 160;
 miniCtx.fillStyle = "#000"; miniCtx.fillRect(0,0,160,160);
 for(let pos in world) {
  const [wx, wy] = pos.split('_').map(Number);
  const info = nations[world[pos]];
  if(info) {
   miniCtx.fillStyle = info.color;
   miniCtx.fillRect(80 + wx/2, 80 + wy/2, 1, 1);
  }
 }
 miniCtx.strokeStyle = "#fff";
 miniCtx.strokeRect(80 + (camX/2) - 4, 80 + (camY/2) - 4, 8, 8);
}

// --- FLAG EDITOR ---
let fCtx, fColor = "#000";
function initFlagEditor() {
 const c = document.getElementById('flag-canvas'); fCtx = c.getContext('2d');
 if(me.flag) { let i = new Image(); i.onload = () => fCtx.drawImage(i,0,0); i.src = me.flag; }
 else { fCtx.fillStyle = "#fff"; fCtx.fillRect(0,0,100,60); }
 const p = document.getElementById('flag-palette');
 ["#000","#fff","#f00","#0f0","#00f","#ff0","#f0f","#0ff"].forEach(col => {
  let d = document.createElement('div'); d.style.width="20px"; d.style.height="20px"; d.style.background=col; d.onclick=()=>fColor=col; p.appendChild(d);
 });
 c.onmousedown = (e) => {
  const rect = c.getBoundingClientRect();
  fCtx.fillStyle = fColor;
  fCtx.fillRect(Math.floor((e.clientX-rect.left)/10)*10, Math.floor((e.clientY-rect.top)/10)*10, 10, 10);
 };
}
function saveFlag() { me.flag = document.getElementById('flag-canvas').toDataURL(); alert("FLAG SAVED"); }

// --- CONTROLS ---
canvas.onmousedown = (e) => {
 if(e.button===0) isPainting=true; else isDragging=true;
 lastMouse = {x: e.clientX, y: e.clientY};
 if(isPainting) { const w = toWorld(e.clientX, e.clientY); claim(w.wx, w.wy); }
};
window.onmousemove = (e) => {
 const w = toWorld(e.clientX, e.clientY);
 document.getElementById('ui-coord').innerText = `${w.wx},${w.wy}`;
 if(isPainting) claim(w.wx, w.wy);
 if(isDragging) {
  camX -= (e.clientX - lastMouse.x)/zoom;
  camY -= (e.clientY - lastMouse.y)/zoom;
  lastMouse = {x: e.clientX, y: e.clientY};
 }
 const target = world[w.wx + "_" + w.wy];
 if(target && target !== me.name) {
  selectedTarget = target;
  document.getElementById('ui-target-name').innerText = target;
  document.getElementById('ui-target-name').style.color = nations[target]?.color || "#fff";
 }
};
window.onmouseup = () => { isPainting = false; isDragging = false; };
canvas.onwheel = (e) => { e.preventDefault(); zoom = Math.min(Math.max(zoom * (e.deltaY>0?0.85:1.15), 4), 150); };

// --- ADMIN ---
window.onkeydown = (e) => {
 if(e.shiftKey && e.altKey && e.code === "KeyA") {
  if(prompt("ADMIN PASS") === "20130504") {
   document.getElementById('admin-panel').style.display = 'block';
   refreshAdmin();
  }
 }
};
function refreshAdmin() {
 const l = document.getElementById('admin-list'); l.innerHTML = "";
 Object.entries(nations).forEach(([name, data]) => {
  l.innerHTML += `<div>${name} - Credits: ${data.money} <button onclick="nationDB.get('${name}').put({money:1000000})">Set 1M</button> <button onclick="nationDB.get('${name}').put(null); world={};">DEL</button></div>`;
 });
}

// --- SYNC & UI ---
function toScreen(wx,wy) { return {x:(wx-camX)*zoom+canvas.width/2, y:(wy-camY)*zoom+canvas.height/2}; }
function toWorld(sx,sy) { return {wx:Math.floor((sx-canvas.width/2)/zoom+camX), wy:Math.floor((sy-canvas.height/2)/zoom+camY)}; }
function setTab(t) {
 ['eco','mil','dip','flg'].forEach(id => document.getElementById('tab-'+id).classList.add('hidden'));
 document.getElementById('tab-'+t).classList.remove('hidden');
 document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
 event.target.classList.add('active');
 if(t==='dip') refreshRank();
}
function updateUI() {
 document.getElementById('ui-money').innerText = Math.floor(me.money).toLocaleString();
 document.getElementById('ui-pop').innerText = Math.floor(me.pop).toLocaleString();
 document.getElementById('ui-area').innerText = me.area.toLocaleString();
 document.getElementById('ui-happy').innerText = me.happy;
 document.getElementById('ui-mil').innerText = Math.floor(me.mil).toLocaleString();
 document.getElementById('ui-oil').innerText = me.oil;
 document.getElementById('ui-iron').innerText = me.iron;
 document.getElementById('ui-gold').innerText = me.gold;
}
function addMsg(n, t, c) {
 const m = document.getElementById('messages');
 const d = document.createElement('div'); d.innerHTML = `<b style="color:${c}">${n}:</b> ${t}`;
 m.appendChild(d); m.scrollTop = m.scrollHeight;
}
document.getElementById('chat-in').onkeypress = (e) => {
 if(e.key==='Enter' && e.target.value) { chatDB.get(Date.now()).put({n:me.name, t:e.target.value, c:me.color}); e.target.value = ""; }
};
function refreshRank() {
 const r = document.getElementById('rank-list');
 const sorted = Object.entries(nations).sort((a,b) => (b[1].area||0) - (a[1].area||0));
 r.innerHTML = sorted.slice(0, 10).map(([name, n], i) => `<div class="row"><span>${i+1}. ${name}</span><span style="color:${n.color}">${n.area||0}</span></div>`).join('');
}
async function saveBackup() { try { await fetch(PANTRY_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ world, nations }) }); } catch(e){} }
async function loadBackup() { try { const res = await fetch(PANTRY_URL); if(res.ok) { const d = await res.json(); if(d.world) world = d.world; if(d.nations) nations = d.nations; } } catch(e){} }
function saveManual() { nationDB.get(me.name).put(me); alert("FORCED SYNC COMPLETE"); }
</script>
</body>
</html>
